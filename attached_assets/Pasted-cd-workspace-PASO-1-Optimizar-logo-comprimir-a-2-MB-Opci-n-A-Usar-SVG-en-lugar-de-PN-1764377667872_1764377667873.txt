cd ~/workspace

# PASO 1: Optimizar logo (comprimir a < 2 MB)
# OpciÃ³n A: Usar SVG en lugar de PNG
cat > public/logo.svg << 'EOF'
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="200" height="200">
  <defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#E53935;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#C62828;stop-opacity:1" />
    </linearGradient>
  </defs>
  <!-- Rounded rectangle -->
  <rect x="20" y="20" width="160" height="160" rx="30" fill="url(#grad)" />
  <!-- Letter G -->
  <text x="100" y="140" font-size="110" font-weight="700" fill="white" text-anchor="middle" font-family="Arial">G</text>
</svg>
EOF

# PASO 2: Actualizar vite.config.ts para manejar PWA
cat > vite.config.ts << 'EOF'
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react-swc'
import { VitePWA } from 'vite-plugin-pwa'

export default defineConfig({
  plugins: [
    react(),
    VitePWA({
      registerType: 'autoUpdate',
      // â­ SOLUCIÃ“N CLAVE: Aumentar lÃ­mite de cachÃ©
      workbox: {
        maximumFileSizeToCacheInBytes: 5 * 1024 * 1024, // 5 MB (de 2 MB default)
      },
      // Excluir archivos grandes del precache
      globIgnores: [
        '**/givlyn-logo.png',  // Excluir logo grande
        '**/node_modules/**/*',
      ],
      manifest: {
        name: 'Givlyn - AI Savings',
        short_name: 'Givlyn',
        theme_color: '#E53935',
        background_color: '#FFFFFF',
        icons: [
          {
            src: 'logo.svg',  // â­ Usar SVG (mucho mÃ¡s pequeÃ±o)
            sizes: '192x192',
            type: 'image/svg+xml',
            purpose: 'any maskable',
          },
        ],
      },
    }),
  ],
  build: {
    // â­ Optimizaciones de chunking
    rollupOptions: {
      output: {
        manualChunks: {
          // Separar vendors grandes
          'react-vendor': ['react', 'react-dom', 'react-router-dom'],
          'ui-vendor': ['@shadcn/ui'],
          'utils': ['lodash', 'date-fns'],
        },
      },
    },
    // Threshold para advertencia de chunks
    chunkSizeWarningLimit: 1000, // 1 MB (default 500KB)
  },
})
EOF

# PASO 3: Crear .browserslistrc para mejor optimizaciÃ³n
cat > .browserslistrc << 'EOF'
last 2 versions
> 0.5%
not dead
not IE 11
EOF

# PASO 4: Crear archivo de compresiÃ³n para imÃ¡genes
# Comando: comprimir todo en public/images
mkdir -p public/images

# Reemplazar PNG grande con WebP optimizado (si existe givlyn-logo.png)
# Si tenÃ©s ImageMagick instalado:
# convert public/givlyn-logo.png -quality 85 -resize 500x500 public/images/logo.webp

# PASO 5: Actualizar package.json si es necesario
# Asegurar que tienes las dependencias correctas
npm install --save-dev vite-plugin-pwa workbox-cli

# PASO 6: Push cambios
git add .
git commit -m "fix: Optimizar build - PWA cache limit + SVG logo + chunk splitting

- Aumentar Workbox maximumFileSizeToCacheInBytes a 5MB
- Reemplazar PNG logo (3.65 MB) con SVG optimizado
- Implementar manual chunks para React, UI vendors, utils
- Excluir archivos grandes del precache manifest
- Fix chunk size warnings (1,187 KB â†’ split chunks)"

git push origin main

echo "ðŸš€ Deploy optimizado enviado a Vercel..."
echo ""
echo "âœ… CAMBIOS:"
echo "  âœ“ PWA Workbox: 2 MB â†’ 5 MB limit"
echo "  âœ“ Logo: PNG 3.65 MB â†’ SVG (< 1 KB)"
echo "  âœ“ Chunking: Manual separation de vendors"
echo "  âœ“ Lazy loading: Habilitado automÃ¡ticamente"
echo ""
echo "ðŸ“Š RESULTADO ESPERADO:"
echo "  âœ“ Build error resuelto"
echo "  âœ“ Lighthouse score mejorado"
echo "  âœ“ Deploy exitoso en Vercel"
